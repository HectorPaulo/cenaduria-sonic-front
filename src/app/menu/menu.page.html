<app-header titulo="Menú"></app-header>

<ion-content [fullscreen]="true" class="bg-black">
  <ion-refresher
    slot="fixed"
    (ionRefresh)="doRefresh($event)"
    pullFactor="0.8"
    pullMin="60"
    pullMax="120"
  >
    <ion-refresher-content></ion-refresher-content>
  </ion-refresher>

  <!-- Categorías Fijas (Slot Fixed) con top ajustado para librar el header principal -->
  <div
    slot="fixed"
    class="categories-bar w-full z-40 backdrop-blur-sm py-4 shadow-sm"
  >
    <div class="flex overflow-x-auto px-4 gap-3 hide-scrollbar">
      @for (categoria of todasCategorias; track $index) {
      <button
        class="whitespace-nowrap px-5 py-2.5 rounded-full text-sm font-bold transition-all duration-200 shadow-sm border flex items-center gap-2"
        [class]="filtroActivo === categoria.name 
            ? 'bg-blue-600 text-white border-blue-600 shadow-blue-900/50 scale-105' 
            : 'bg-gray-900 text-gray-400 border-gray-800 hover:bg-gray-800 hover:border-gray-700'"
        (click)="filtrarPorCategoria(categoria.name)"
      >
        {{ categoria.name }}
      </button>
      }
    </div>
  </div>

  <!-- Floating Search Button (positioned below categories) -->
  @if (!showSearchBar) {
  <button
    (click)="toggleSearchBar()"
    class="fixed top-36 right-4 z-50 bg-blue-600 text-white w-12 h-12 rounded-full flex items-center justify-center shadow-lg hover:bg-blue-700 transition-all active:scale-95"
    style="box-shadow: 0 4px 12px rgba(37, 99, 235, 0.4)"
  >
    <ion-icon name="search" class="text-2xl"></ion-icon>
  </button>
  }

  <!-- Expandable Search Bar -->
  @if (showSearchBar) {
  <div
    slot="fixed"
    class="w-full z-[60] backdrop-blur-sm py-3 px-4 shadow-md"
    style="border-bottom: 1px solid rgba(55, 65, 81, 0.5)"
  >
    <div class="max-w-lg mx-auto relative">
      <ion-icon
        name="search"
        class="absolute left-4 top-1/2 -translate-y-1/2 text-gray-400 text-xl pointer-events-none z-10"
      ></ion-icon>
      <input
        type="text"
        [(ngModel)]="searchTerm"
        (input)="onSearchInput()"
        placeholder="Buscar productos..."
        class="w-full bg-gray-900 text-white rounded-full pl-12 pr-12 py-3 text-sm border border-gray-800 focus:border-blue-600 focus:outline-none transition-colors"
        autofocus
      />
      <button
        (click)="toggleSearchBar()"
        class="absolute right-4 top-1/2 -translate-y-1/2 text-gray-400 hover:text-white transition-colors"
      >
        <ion-icon name="close-circle" class="text-xl"></ion-icon>
      </button>
    </div>
  </div>
  }

  <!-- Contenedor principal con padding superior grande para compensar header + barra + botón -->
  <div class="max-w-lg mx-auto p-4 pb-24 pt-20">
    <!-- Título de sección dinámica -->
    <div class="flex justify-between items-end mb-4 px-1">
      <h2 class="text-2xl font-bold text-white">
        @if (isSearching) { Resultados de búsqueda } @else { {{ filtroActivo &&
        filtroActivo !== 'Todos' ? filtroActivo : 'Todo el Menú' }} }
      </h2>
      <span class="text-sm text-gray-400 font-medium mb-1">
        {{ comidasFiltradas.length }} productos
      </span>
    </div>

    <!-- Lista de Comida -->
    @if (comidasFiltradas.length > 0) {
    <div class="grid grid-cols-1 gap-4">
      @for (comida of comidasFiltradas; track $index) {
      <div
        class="bg-gray-900 rounded-2xl p-3 shadow-lg border border-gray-800 flex gap-4 transition-transform active:scale-[0.98]"
      >
        <!-- Imagen -->
        <div
          class="w-28 h-28 flex-shrink-0 rounded-xl bg-gray-800 overflow-hidden relative shadow-inner"
        >
          <img
            [src]="comida.imageUrl"
            [alt]="comida.name"
            class="w-full h-full object-cover"
          />
        </div>

        <!-- Info -->
        <div class="flex-1 flex flex-col min-w-0 py-1">
          <div class="flex justify-between items-start mb-1">
            <h3
              class="font-bold text-white text-lg leading-tight line-clamp-2 pr-2"
            >
              {{ comida.name }}
            </h3>
          </div>

          <p class="text-xs text-gray-400 line-clamp-2 mb-3 leading-relaxed">
            {{ comida.description || 'Delicioso platillo preparado al momento
            con los mejores ingredientes.' }}
          </p>

          <div class="flex justify-between items-center mt-auto">
            <span class="font-bold text-xl text-white"
              >${{ comida.price }}</span
            >

            <button
              class="bg-blue-600 text-white active:bg-blue-500 transition-colors w-10 h-10 rounded-full flex items-center justify-center shadow-md shadow-blue-900/30"
              (click)="addToCart(comida); $event.stopPropagation()"
            >
              <ion-icon name="add" class="text-xl font-bold"></ion-icon>
            </button>
          </div>
        </div>
      </div>
      }
    </div>
    }

    <!-- Mensaje cuando no hay resultados -->
    @if (comidasFiltradas.length === 0) {
    <div class="text-center py-12 px-6">
      <div
        class="bg-gray-900 w-24 h-24 rounded-full flex items-center justify-center mx-auto mb-6 border border-gray-800"
      >
        <ion-icon name="search" class="text-4xl text-gray-600"></ion-icon>
      </div>
      <h3 class="text-xl font-bold text-white mb-2">Sin resultados</h3>
      <p class="text-gray-400 mb-6 max-w-xs mx-auto">
        @if (isSearching) { No encontramos productos que coincidan con "{{
        searchTerm }}". } @else { No encontramos productos en la categoría "{{
        filtroActivo }}". Intenta con otra. }
      </p>
      <ion-button
        mode="ios"
        color="primary"
        class="font-bold rounded-xl"
        (click)="isSearching ? clearSearch() : resetearFiltros()"
      >
        {{ isSearching ? 'Limpiar búsqueda' : 'Ver todo el menú' }}
      </ion-button>
    </div>
    }
  </div>

  <app-fabbtn></app-fabbtn>
</ion-content>
