<app-header titulo="Editar Menú"></app-header>

<ion-content class="ion-padding">
  <!-- Add Product Button -->
  <div class="add-product-section">
    <ion-button expand="block" color="primary" size="large" (click)="openAdd()">
      <ion-icon name="add-circle" slot="start"></ion-icon>
      Agregar Nuevo Producto
    </ion-button>
  </div>

  <!-- Search Bar -->
  <ion-searchbar
    [(ngModel)]="searchTerm"
    placeholder="Buscar por nombre o categoría..."
    animated="true"
    class="search-bar"
  ></ion-searchbar>

  <!-- Products Grid -->
  <div class="products-grid" *ngIf="filteredItems.length > 0">
    <ion-card *ngFor="let item of filteredItems" class="product-card">
      <div class="product-image-container">
        <img
          *ngIf="item.imageUrl"
          [src]="item.imageUrl"
          [alt]="item.name"
          class="product-image"
        />
        <div *ngIf="!item.imageUrl" class="product-image-placeholder">
          <ion-icon name="image-outline"></ion-icon>
        </div>
        <ion-badge
          [color]="item.active ? 'success' : 'medium'"
          class="status-badge"
        >
          {{ item.active ? 'Activo' : 'Inactivo' }}
        </ion-badge>
      </div>

      <ion-card-content>
        <h3 class="product-name">{{ item.name }}</h3>
        <p class="product-price">${{ item.price | number: '1.2-2' }}</p>
        <p class="product-category" *ngIf="item.category">
          <ion-icon name="pricetag-outline"></ion-icon>
          {{ item.category.name }}
        </p>

        <div class="product-actions">
          <ion-button fill="outline" size="small" (click)="edit(item)">
            <ion-icon name="create-outline" slot="start"></ion-icon>
            Editar
          </ion-button>
          <ion-button
            fill="outline"
            size="small"
            color="danger"
            (click)="remove(item)"
          >
            <ion-icon name="trash-outline" slot="start"></ion-icon>
            Eliminar
          </ion-button>
        </div>
      </ion-card-content>
    </ion-card>
  </div>

  <!-- Empty State -->
  <div *ngIf="filteredItems.length === 0" class="empty-state">
    <ion-icon name="restaurant-outline"></ion-icon>
    <h3>No hay productos</h3>
    <p>
      {{ searchTerm ? 'No se encontraron productos con "' + searchTerm + '"' :
      'Comienza agregando tu primer producto al menú' }}
    </p>
  </div>

  <!-- Product Form Modal -->
  <div
    *ngIf="isFormOpen"
    class="modal-overlay"
    (click)="cancelEdit(); isFormOpen = false"
  >
    <ion-card class="modal-card" (click)="$event.stopPropagation()">
      <ion-header>
        <ion-toolbar>
          <ion-title>
            <ion-icon [name]="editingId ? 'create' : 'add-circle'"></ion-icon>
            {{ editingId ? 'Editar Producto' : 'Nuevo Producto' }}
          </ion-title>
          <ion-buttons slot="end">
            <ion-button (click)="cancelEdit(); isFormOpen = false">
              <ion-icon name="close"></ion-icon>
            </ion-button>
          </ion-buttons>
        </ion-toolbar>
      </ion-header>

      <ion-card-content class="modal-content">
        <form [formGroup]="form" (ngSubmit)="save()">
          <div class="form-section">
            <ion-item lines="none" class="form-item">
              <ion-label position="floating">
                <ion-icon name="text-outline"></ion-icon>
                Nombre del Producto
              </ion-label>
              <ion-input
                formControlName="name"
                placeholder="Ej: Tacos al Pastor"
              ></ion-input>
            </ion-item>

            <ion-item lines="none" class="form-item">
              <ion-label position="floating">
                <ion-icon name="cash-outline"></ion-icon>
                Precio
              </ion-label>
              <ion-input
                type="number"
                formControlName="price"
                placeholder="0.00"
                step="0.01"
              ></ion-input>
            </ion-item>

            <ion-item lines="none" class="form-item">
              <ion-label>
                <ion-icon name="pricetag-outline"></ion-icon>
                Categoría
              </ion-label>
              <ion-select
                formControlName="categoryId"
                interface="popover"
                placeholder="Selecciona una categoría"
              >
                <ion-select-option
                  *ngFor="let cat of categories"
                  [value]="cat.id"
                >
                  {{ cat.name }}
                </ion-select-option>
              </ion-select>
            </ion-item>

            <ion-item lines="none" class="form-item toggle-item">
              <ion-icon name="checkmark-circle-outline"></ion-icon>
              <ion-label>Producto Disponible</ion-label>
              <ion-toggle slot="end" formControlName="active"></ion-toggle>
            </ion-item>

            <div class="image-upload-section">
              <label class="image-upload-label">
                <ion-icon name="image-outline"></ion-icon>
                Imagen del Producto (Opcional)
              </label>
              <input
                type="file"
                accept="image/*"
                (change)="onFileSelected($event)"
                #fileInput
                style="display: none"
              />
              <ion-button
                expand="block"
                fill="outline"
                (click)="fileInput.click()"
              >
                <ion-icon name="cloud-upload-outline" slot="start"></ion-icon>
                {{ selectedFile ? selectedFile.name : 'Seleccionar Imagen' }}
              </ion-button>
            </div>
          </div>

          <div class="modal-actions">
            <ion-button
              expand="block"
              type="submit"
              color="primary"
              size="large"
              [disabled]="form.invalid"
            >
              <ion-icon
                [name]="editingId ? 'save-outline' : 'add-circle-outline'"
                slot="start"
              ></ion-icon>
              {{ editingId ? 'Guardar Cambios' : 'Agregar Producto' }}
            </ion-button>
          </div>
        </form>
      </ion-card-content>
    </ion-card>
  </div>
</ion-content>
