<app-header titulo="Pedidos de los usuarios"></app-header>

<ion-content [fullscreen]="true" class="ion-padding">
  <ion-refresher
    slot="fixed"
    (ionRefresh)="doRefresh($event)"
    pullFactor="0.8"
    pullMin="60"
    pullMax="120"
  >
    <ion-refresher-content></ion-refresher-content>
  </ion-refresher>
  <app-fabbtn></app-fabbtn>
  <div class="pedidos-header mt-20">
    <p>Gestiona el estado de los pedidos en tiempo real</p>
  </div>

  <ion-list>
    <ng-container *ngIf="loading" class="ion-text-center p-4">
      <ion-spinner name="crescent"></ion-spinner>
    </ng-container>
    <ng-container
      *ngIf="!loading && pedidos.length === 0"
      class="w-full p-6 text-center text-gray-400"
    >
      No hay pedidos.
    </ng-container>

    <!-- Pendientes -->
    <ion-card class="mb-4">
      <ion-card-header>
        <ion-card-title>Pendientes</ion-card-title>
      </ion-card-header>
      <ion-card-content>
        <ng-container
          *ngIf="pedidosPendientes.length > 0; else emptyPendientes"
        >
          <ion-item
            class="pedido-item"
            *ngFor="let pedido of pedidosPendientes; let i = index; trackBy: trackById"
          >
            <ion-label>
              <div class="pedido-header">
                <h3>{{ pedido.id }} - {{ pedido.cliente }}</h3>
                <ion-badge [color]="getEstadoColor(pedido.estado)">
                  <ion-icon [name]="getEstadoIcon(pedido.estado)"></ion-icon>
                  {{ getEstadoTexto(pedido.estado) }}
                </ion-badge>
              </div>
              <div class="pedido-details">
                <p><strong>Total:</strong> ${{ pedido.total }}</p>
                <p><strong>Hora:</strong> {{ pedido.tiempo }}</p>
              </div>
              <div class="pedido-actions">
                <ion-item lines="none">
                  <ion-select
                    interface="popover"
                    placeholder="Estado"
                    [value]="pedido.statusServer || ''"
                    (ionChange)="changeOrderStatus(pedido, $event.detail.value)"
                  >
                    <ion-select-option value="EN_PREPARACION"
                      >En preparación</ion-select-option
                    >
                    <ion-select-option value="LISTO">Listo</ion-select-option>
                    <ion-select-option value="ENTREGADO"
                      >Entregado</ion-select-option
                    >
                  </ion-select>
                </ion-item>
                <ion-button
                  size="small"
                  color="danger"
                  (click)="confirmCancel(pedido)"
                  [disabled]="changingStatus[pedido.raw?.id || pedido.id]"
                >
                  <ion-icon name="close" slot="start"></ion-icon>
                  Cancelar
                </ion-button>
              </div>
            </ion-label>
          </ion-item>
        </ng-container>
        <ng-template #emptyPendientes>
          <div class="ion-padding">No hay pedidos pendientes.</div>
        </ng-template>
      </ion-card-content>
    </ion-card>

    <!-- En preparación -->
    <ion-card class="mb-4">
      <ion-card-header>
        <ion-card-title>En preparación</ion-card-title>
      </ion-card-header>
      <ion-card-content>
        <ng-container
          *ngIf="pedidosPreparando.length > 0; else emptyPreparando"
        >
          <ion-item
            class="pedido-item"
            *ngFor="let pedido of pedidosPreparando; let i = index; trackBy: trackById"
          >
            <ion-label>
              <div class="pedido-header">
                <h3>{{ pedido.id }} - {{ pedido.cliente }}</h3>
                <ion-badge [color]="getEstadoColor(pedido.estado)">
                  <ion-icon [name]="getEstadoIcon(pedido.estado)"></ion-icon>
                  {{ getEstadoTexto(pedido.estado) }}
                </ion-badge>
              </div>
              <div class="pedido-details">
                <p><strong>Total:</strong> ${{ pedido.total }}</p>
                <p><strong>Hora:</strong> {{ pedido.tiempo }}</p>
              </div>
              <div class="pedido-actions">
                <ion-item lines="none">
                  <ion-select
                    interface="popover"
                    placeholder="Estado"
                    [value]="pedido.statusServer || ''"
                    (ionChange)="changeOrderStatus(pedido, $event.detail.value)"
                  >
                    <ion-select-option value="EN_PREPARACION"
                      >En preparación</ion-select-option
                    >
                    <ion-select-option value="LISTO">Listo</ion-select-option>
                    <ion-select-option value="ENTREGADO"
                      >Entregado</ion-select-option
                    >
                  </ion-select>
                </ion-item>
              </div>
            </ion-label>
          </ion-item>
        </ng-container>
        <ng-template #emptyPreparando>
          <div class="ion-padding">No hay pedidos en preparación.</div>
        </ng-template>
      </ion-card-content>
    </ion-card>

    <!-- Listos -->
    <ion-card class="mb-4">
      <ion-card-header>
        <ion-card-title>Listos</ion-card-title>
      </ion-card-header>
      <ion-card-content>
        <ng-container *ngIf="pedidosListos.length > 0; else emptyListos">
          <ion-item
            class="pedido-item"
            *ngFor="let pedido of pedidosListos; let i = index; trackBy: trackById"
          >
            <ion-label>
              <div class="pedido-header">
                <h3>{{ pedido.id }} - {{ pedido.cliente }}</h3>
                <ion-badge [color]="getEstadoColor(pedido.estado)">
                  <ion-icon [name]="getEstadoIcon(pedido.estado)"></ion-icon>
                  {{ getEstadoTexto(pedido.estado) }}
                </ion-badge>
              </div>
              <div class="pedido-details">
                <p><strong>Total:</strong> ${{ pedido.total }}</p>
                <p><strong>Hora:</strong> {{ pedido.tiempo }}</p>
              </div>
            </ion-label>
          </ion-item>
        </ng-container>
        <ng-template #emptyListos>
          <div class="ion-padding">No hay pedidos listos.</div>
        </ng-template>
      </ion-card-content>
    </ion-card>

    <!-- Entregados -->
    <ion-card class="mb-4">
      <ion-card-header>
        <ion-card-title>Entregados</ion-card-title>
      </ion-card-header>
      <ion-card-content>
        <ng-container
          *ngIf="pedidosEntregados.length > 0; else emptyEntregados"
        >
          <ion-item
            class="pedido-item"
            *ngFor="let pedido of pedidosEntregados; let i = index; trackBy: trackById"
          >
            <ion-label>
              <div class="pedido-header">
                <h3>{{ pedido.id }} - {{ pedido.cliente }}</h3>
                <!-- <ion-badge [color]="getEstadoColor(pedido.estado)">
                  <ion-icon [name]="getEstadoIcon(pedido.estado)"></ion-icon>
                  {{ getEstadoTexto(pedido.estado) }}
                </ion-badge> -->
              </div>
              <div class="pedido-details">
                <p><strong>Total:</strong> ${{ pedido.total }}</p>
                <p><strong>Hora:</strong> {{ pedido.tiempo }}</p>
              </div>
            </ion-label>
          </ion-item>
        </ng-container>
        <ng-template #emptyEntregados>
          <div class="ion-padding">No hay pedidos entregados.</div>
        </ng-template>
      </ion-card-content>
    </ion-card>
  </ion-list>
</ion-content>
