<app-header titulo="Gesti√≥n de Pedidos"></app-header>

<ion-content [fullscreen]="true" class="orders-content">
  <ion-refresher
    slot="fixed"
    (ionRefresh)="doRefresh($event)"
    pullFactor="0.8"
    pullMin="60"
    pullMax="120"
  >
    <ion-refresher-content></ion-refresher-content>
  </ion-refresher>
  <app-fabbtn></app-fabbtn>

  <div class="orders-container">
    <!-- Header -->
    <div class="orders-header">
      <h2 class="header-title">Pedidos</h2>
      <p class="header-subtitle">
        Gestiona el estado de los pedidos en tiempo real
      </p>
    </div>

    <!-- Status Filter Tabs -->
    <div class="status-tabs">
      <button
        class="status-tab"
        [class.active]="selectedSegment === 'PENDIENTE'"
        (click)="segmentChanged({detail: {value: 'PENDIENTE'}})"
      >
        <span class="tab-label">Pendientes</span>
      </button>
      <button
        class="status-tab"
        [class.active]="selectedSegment === 'EN_PREPARACION'"
        (click)="segmentChanged({detail: {value: 'EN_PREPARACION'}})"
      >
        <span class="tab-label">En Preparaci√≥n</span>
      </button>
      <button
        class="status-tab"
        [class.active]="selectedSegment === 'LISTO'"
        (click)="segmentChanged({detail: {value: 'LISTO'}})"
      >
        <span class="tab-label">Listos</span>
      </button>
      <button
        class="status-tab"
        [class.active]="selectedSegment === 'ENTREGADO'"
        (click)="segmentChanged({detail: {value: 'ENTREGADO'}})"
      >
        <span class="tab-label">Entregados</span>
      </button>
    </div>

    <!-- Loading -->
    <div *ngIf="loading" class="loading-state">
      <ion-spinner name="crescent"></ion-spinner>
    </div>

    <!-- Empty State -->
    <div *ngIf="!loading && pedidos.length === 0" class="empty-state">
      <div class="empty-icon">üìã</div>
      <h3 class="empty-title">Sin pedidos</h3>
      <p class="empty-subtitle">No hay pedidos en esta categor√≠a</p>
    </div>

    <!-- Orders List -->
    <div *ngIf="!loading && pedidos.length > 0" class="orders-list">
      @for (pedido of pedidos; track pedido.id) {
      <div class="order-card">
        <!-- Card Header -->
        <div class="order-header">
          <div class="order-info">
            <h3 class="order-number">#{{ pedido.id }}</h3>
            <p class="order-customer">{{ pedido.cliente }}</p>
            <p class="order-time">{{ pedido.tiempo }}</p>
          </div>
          <ion-badge
            [color]="getEstadoColor(pedido.estado)"
            class="order-badge"
          >
            <ion-icon [name]="getEstadoIcon(pedido.estado)"></ion-icon>
            {{ getEstadoTexto(pedido.estado) }}
          </ion-badge>
        </div>

        <!-- Order Items -->
        <div class="order-items">
          @for (item of pedido.items; track $index) {
          <div class="order-item">
            <img
              *ngIf="item.imageUrl"
              [src]="item.imageUrl"
              class="item-image"
              alt="item"
            />
            <div class="item-info">
              <span class="item-quantity">{{ item.quantity }}x</span>
              <span class="item-name">{{ item.name }}</span>
              @if (item.type === 'PROMOTION') {
              <span class="item-promo">üéÅ</span>
              }
            </div>
            <span class="item-price">${{ item.total | number:'1.2-2' }}</span>
          </div>
          }
        </div>

        <!-- Order Total -->
        <div class="order-total">
          <span class="total-label">Total:</span>
          <span class="total-value">${{ pedido.total | number:'1.2-2' }}</span>
        </div>

        <!-- Actions -->
        <div class="order-actions">
          <button
            class="action-btn btn-outline"
            (click)="viewOrderDetails(pedido)"
          >
            <ion-icon name="information-circle"></ion-icon>
            Detalles
          </button>

          @if (canChangeStatus(pedido)) {
          <button
            class="action-btn btn-outline"
            (click)="updateEstimatedTime(pedido)"
          >
            <ion-icon name="time"></ion-icon>
            Tiempo
          </button>

          <button
            *ngIf="getNextStatus(pedido)"
            class="action-btn btn-outline"
            (click)="changeOrderStatus(pedido, getNextStatus(pedido))"
            [disabled]="changingStatus[pedido.raw?.id || pedido.id]"
          >
            <ion-icon name="arrow-forward-circle"></ion-icon>
            {{ getNextStatusLabel(pedido) }}
          </button>
          } @if (canCancel(pedido)) {
          <button
            class="action-btn btn-danger"
            (click)="confirmCancel(pedido)"
            [disabled]="changingStatus[pedido.raw?.id || pedido.id]"
          >
            <ion-icon name="close"></ion-icon>
            Cancelar
          </button>
          }
        </div>
      </div>
      }
    </div>

    <!-- Pagination -->
    <div *ngIf="!loading && pedidos.length > 0" class="pagination">
      <button
        class="pagination-btn"
        [disabled]="currentPage === 0"
        (click)="prevPage()"
      >
        Anterior
      </button>
      <span class="pagination-info">
        P√°gina {{ currentPage + 1 }} de {{ totalPages || 1 }} ({{ totalElements
        }} pedidos)
      </span>
      <button
        class="pagination-btn"
        [disabled]="currentPage >= totalPages - 1 || totalPages <= 1"
        (click)="nextPage()"
      >
        Siguiente
      </button>
    </div>
  </div>

  <!-- Order Details Modal -->
  <ion-modal [isOpen]="isModalOpen" (didDismiss)="closeModal()">
    <ng-template>
      <ion-header class="ion-no-border">
        <ion-toolbar class="modal-toolbar">
          <ion-title>Pedido #{{ selectedOrder?.id }}</ion-title>
          <ion-buttons slot="end">
            <ion-button (click)="closeModal()">
              <ion-icon name="close" slot="icon-only"></ion-icon>
            </ion-button>
          </ion-buttons>
        </ion-toolbar>
      </ion-header>
      <ion-content class="modal-content" *ngIf="selectedOrder">
        <div class="modal-body">
          <!-- Customer Info -->
          <div class="info-card">
            <h3 class="info-title">Cliente</h3>
            <p><strong>Nombre:</strong> {{ selectedOrder.user?.fullName }}</p>
            <p><strong>Email:</strong> {{ selectedOrder.user?.email }}</p>
          </div>

          <!-- Order Info -->
          <div class="info-card">
            <h3 class="info-title">Informaci√≥n del Pedido</h3>
            <p><strong>Estado:</strong> {{ selectedOrder.status }}</p>
            <p>
              <strong>Tiempo estimado:</strong> {{ selectedOrder.estimatedTime
              }}
            </p>
            <p>
              <strong>Creado:</strong> {{ selectedOrder.createdAt |
              date:'dd/MM/yyyy HH:mm' }}
            </p>
            <p *ngIf="selectedOrder.deliveredAt">
              <strong>Entregado:</strong> {{ selectedOrder.deliveredAt |
              date:'dd/MM/yyyy HH:mm' }}
            </p>
          </div>

          <!-- Items -->
          <div class="info-card">
            <h3 class="info-title">Productos</h3>
            @for (item of selectedOrder.items; track $index; let last = $last) {
            <div class="modal-item" [class.last]="last">
              <img
                *ngIf="item.imageUrl"
                [src]="item.imageUrl"
                class="modal-item-image"
                alt="item"
              />
              <div class="modal-item-info">
                <p class="modal-item-name">{{ item.itemName }}</p>
                <p class="modal-item-type">
                  {{ item.type === 'PROMOTION' ? 'üéÅ Promoci√≥n' : 'üçΩÔ∏è Producto'
                  }}
                </p>
                <p class="modal-item-quantity">
                  {{ item.quantity }} √ó ${{ item.unitPrice | number:'1.2-2' }}
                </p>
              </div>
              <div class="modal-item-total">
                ${{ item.lineTotal | number:'1.2-2' }}
              </div>
            </div>
            }

            <!-- Summary -->
            <div class="modal-summary">
              <div class="summary-row">
                <span>Subtotal:</span>
                <span>${{ selectedOrder.subtotal | number:'1.2-2' }}</span>
              </div>
              <div class="summary-row">
                <span>Propina:</span>
                <span>${{ selectedOrder.tip | number:'1.2-2' }}</span>
              </div>
              <div class="summary-row total">
                <span>Total:</span>
                <span>${{ selectedOrder.total | number:'1.2-2' }}</span>
              </div>
            </div>
          </div>
        </div>
      </ion-content>
    </ng-template>
  </ion-modal>
</ion-content>
